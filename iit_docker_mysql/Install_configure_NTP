#! /usr/bin/env bash

set +e

source "$RS_ATTACH_DIR/rs_distro.sh"

#
# ---
# RightScript Name: BASE ntp
# Description: Installs and configures ntp client.
# Packages: ntp ntpdate
# Inputs:
#   NTP_SERVERS:
#     Input Type: array
#     Category: RightScale
#     Default: array:["text:time.rightscale.com","text:ec2-us-east.time.rightscale.com","text:ec2-us-west.time.rightscale.com"]
#     Description: >
#       A comma-separated list of fully qualified domain names for the array of servers that instances should talk to.
#       Example: time1.example.com, time2.example.com, time3.example.com
#     Advanced: true
# ...
#

if [ "$RS_DISTRO" = 'atomichost' ]; then
  echo 'Red Hat Enterprise Linux Atomic Host not yet supported, but will exit gracefully.'
  exit 0
fi

# ensure ntp packages installed
if type -P yum >/dev/null 2>&1; then
  sudo yum -y install ntp ntpdate
elif type -P apt-get >/dev/null 2>&1; then
  sudo apt-get -y install ntp ntpdate
fi

# Use defaults for inputs that are not set
: ${NTP_SERVERS:=time.rightscale.com,ec2-us-east.time.rightscale.com,ec2-us-west.time.rightscale.com}

# Check if a file needs to be written. First checks if the target file exists and if so checks if the checksums of the
# target file and the temporary file match.
#
# $1: the target file path to be checked
# $2: the temporary file path with new contents to check against
#
function run_check_write_needed() {
  [[ ! -f $1 ]] || [[ `run_checksum $2` != `run_checksum $1` ]]
}

# Get the SHA256 checksum of a file.
#
# $1: the file path to get the checksum from
#
function run_checksum() {
  sha256sum $1 | cut -d ' ' -f 1
}

# Add a temporary file to the list of temporary files to clean up on exit.
#
# $@: one or more file paths to add to the list
#
function add_mktemp_file() {
  mktemp_files=("$@" "${mktemp_files[@]}")
}

# Declare a list for temporary files to clean up on exit and set the command to delete them if they still exist when the
# script exits
declare -a mktemp_files
trap 'sudo rm --force "${mktemp_files[@]}"' EXIT

# Initialize variables
ntp_var_lib=/var/lib/ntp
ntp_stats=/var/log/ntpstats
ntp_conf=/etc/ntp.conf
ntp_service_notify=0

# Read NTP servers input into an array
IFS=',' read -a ntp_servers <<<"$NTP_SERVERS"

case $RS_DISTRO in
(ubuntu|debian)
  ntp_service=ntp
  ;;
(centos|redhatenterpriseserver)
  ntp_service=ntpd
  ;;
(*)
  echo "unsupported distribution '$RS_DISTRO'!"
  exit 1
  ;;
esac

sudo mkdir --mode=0755 --parents $ntp_var_lib $ntp_stats
sudo chown ntp:ntp $ntp_var_lib $ntp_stats

# Create a temporary file for the NTP configuration
ntp_conf_tmp=`sudo mktemp "${ntp_conf}.XXXXXXXXXX"`
add_mktemp_file $ntp_conf_tmp

sudo bash -c "cat >$ntp_conf_tmp" <<EOF
# Generated by BASE ntp RightScript
tinker panic 0
statsdir $ntp_stats/
driftfile $ntp_var_lib/ntp.drift

statistics loopstats peerstats clockstats
filegen loopstats file loopstats type day enable
filegen peerstats file peerstats type day enable
filegen clockstats file clockstats type day enable

disable monitor

EOF

for ntp_server in "${ntp_servers[@]}"; do
  sudo bash -c "cat >$ntp_conf_tmp" <<EOF
server $ntp_server iburst
restrict $ntp_server nomodify notrap noquery
EOF
done


sudo bash -c "cat >$ntp_conf_tmp" <<EOF

restrict default kod notrap nomodify nopeer noquery
restrict 127.0.0.1 nomodify
restrict -6 default kod notrap nomodify nopeer noquery
restrict -6 ::1 nomodify
EOF

# Overwrite and backup the NTP configuration if it has changed
if run_check_write_needed $ntp_conf $ntp_conf_tmp; then
  sudo chown ntp:ntp $ntp_conf_tmp
  sudo chmod 0644 $ntp_conf_tmp
  [[ -f $ntp_conf ]] && sudo cp --archive $ntp_conf "${ntp_conf}.`date -u +%Y%m%d%H%M%S`"
  sudo mv --force $ntp_conf_tmp $ntp_conf
  ntp_service_notify=1
fi

# Make sure the NTP service is enabled
case $RS_DISTRO in
(centos|redhatenterpriseserver)
  sudo chkconfig $ntp_service on
  ;;
esac

# Start the NTP service if it is not running or restart it if it needs to be restarted
if ! service $ntp_service status; then
  sudo service $ntp_service start
elif [[ $ntp_service_notify -eq 1 ]]; then
  sudo service $ntp_service restart
fi